{% extends "base.html" %}

{% block title %}Irrigation Schedule{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="info-card">
        <h2 class="mb-4 text-dark text-center">Set Irrigation Schedule</h2>
        <form id="irrigationForm">
            <div class="mb-3">
                <label for="startTime" class="form-label">Start Time</label>
                <input type="time" class="form-control" id="startTime" name="start_time" required>
            </div>
            <div class="mb-3">
                <label for="endTime" class="form-label">End Time</label>
                <input type="time" class="form-control" id="endTime" name="end_time" required>
            </div>
            <div class="mb-3">
                <label for="duration" class="form-label">Duration (minutes)</label>
                <input type="number" class="form-control" id="duration" name="duration_minutes" min="1" required>
            </div>
            <div class="mb-3">
                <label for="frequency" class="form-label">Frequency</label>
                <select class="form-select" id="frequency" name="frequency" required>
                    <option value="daily">Daily</option>
                    <option value="weekly">Weekly</option>
                    <option value="bi-weekly">Bi-Weekly</option>
                    <option value="custom">Custom</option>
                </select>
            </div>
            <button type="submit" class="btn btn-primary w-100">Save Schedule</button>
        </form>

        {% if last_schedule %}
        <div class="mt-5 p-3 border rounded bg-light">
            <h4 class="text-dark">Last Saved Schedule:</h4>
            <p><strong>Start Time:</strong> {{ last_schedule.start_time }}</p>
            <p><strong>End Time:</strong> {{ last_schedule.end_time }}</p>
            <p><strong>Duration:</strong> {{ last_schedule.duration_minutes }} minutes</p>
            <p><strong>Frequency:</strong> {{ last_schedule.frequency }}</p>
            <p class="text-muted">Saved on: {{ last_schedule.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}</p>
        </div>
        {% else %}
        <div class="alert alert-info mt-4 text-center" role="alert">
            No irrigation schedule saved yet.
        </div>
        {% endif %}
    </div>
</div>

<script>
    document.getElementById('irrigationForm').addEventListener('submit', async function(event) {
        event.preventDefault();

        const formData = new FormData(this);
        const data = Object.fromEntries(formData.entries());

        try {
            const response = await fetch('/irrigation', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.status === 'success') {
                alert(result.message);
                window.location.reload(); // Reload to show the updated last schedule
            } else {
                alert('Error: ' + result.message);
            }
        } catch (error) {
            console.error('Error:', error);
            alert('An unexpected error occurred.');
        }
    });
</script>
{% endblock %}